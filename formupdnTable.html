<html>
<head>
<!-- DW6 -->
<title>jQuery::Up/Downキーでフォームを移動（デモ版）</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link href="formupdn_files/wsjp2.css" rel="stylesheet" type="text/css">
</head>
<body bgcolor="#ffffff" text="#000000">
<a name="body"></a>
<script language="javascript" type="text/javascript" src="./jquery-1.3.2.min.js"></script>
<script language="javascript" type="text/javascript" src="./jquery.hotkeys-0.7.8.js"></script>
<script language="JavaScript">
<!--
var focusElem;  // フォーカスされたオブジェクトそのもの
var jFormElem;  // フォーム内のエレメント一覧（jQueryオブジェクト）
var jFormLeng;  // エレメントの数

$(document).ready( function() 
{
	// フォーム要素の配列を生成。
	jFormElem = 
		$( 'form' ).map( function() {
			var ele = $.makeArray( this.elements );
			return ele;
		}).filter( function() {
			if( this.type == 'hidden' ) {
				return false;
			}
			return true;
		}).each( function(i) {
			$(this).attr( 'focusIndex', i );
		});
	jFormLeng = jFormElem.length;
	
	// フォームエレメントがフォーカスされたら記録。
	$(jFormElem).focus( function() {
		focusElem = jQuery( this );
	});
	// 要素#0にフォーカスを当てる。
	jFormElem.get(1).focus();
    
	// +--------------------------------------------------------------+
    /**
     * Ctrl+RIGHT: go to the next element.
     */
    var formRight =function( event ) 
	{
		var keyPropagate = true;
		if( !focusElem ) return keyPropagate;
		if( !$(focusElem).attr( 'focusIndex' ) ) return keyPropagate;
		
		var fIndex = parseInt( $(focusElem).attr( 'focusIndex' ) );
		
		if( fIndex == jFormLeng-1 ) {
			$(jFormElem).get(0).focus();
		}
		else {
			$(jFormElem).get( fIndex+1 ).focus();
		}
		keyPropagate = false;
		return keyPropagate;
	};
	$(jFormElem).bind( 'keydown', 'ctrl+right', formRight );
	
    // +--------------------------------------------------------------+
	/** 
     * Ctrl+Left: go to the previous element.
     */
    var formLeft = function( event ) 
	{
		var keyPropagate = true;
		if( !focusElem ) return keyPropagate;
		if( !$(focusElem).attr( 'focusIndex' ) ) return keyPropagate;
		
		var fIndex = parseInt( $(focusElem).attr( 'focusIndex' ) );
		if( fIndex == 0 ) {
			$(jFormElem).get( jFormLeng-1 ).focus();
		} 
		else {
			$(jFormElem).get( fIndex-1 ).focus();
		}
		keyPropagate = false;
		return keyPropagate;
	};
	$(jFormElem).bind( 'keydown', 'ctrl+left', formLeft );
    
	// +--------------------------------------------------------------+
	/**
     * Ctrl+DOWNç go down the table or the next element.
     */
    var formDown = function( event ) 
	{
		var keyPropagate = true;
		if( !focusElem ) return keyPropagate;
		if( !$(focusElem).attr( 'focusIndex' ) ) return keyPropagate;
		
		var fIndex = parseInt( $(focusElem).attr( 'focusIndex' ) );
		
		// テーブル・配列の処理
		var fName  = $(focusElem).attr( 'name' );
		if( fName.match( /\[/ ) ) 
		{
			var fNameBody     = fName.match( /^([\w]+)/ )[0];
			var toFocus_idx   = '-1'; // 同じ配列名で次の項目
			var follow_item   = '-1'; // 配列外で、配列の次の項目
			var top_item      = '-1'; // 配列外で、最初の項目
			var first_item    = '-1'; // 同じ配列名で最初の項目
			$( jFormElem ).each( function( idx ) 
			{
				var this_fIdx     = $( this ).attr( 'focusIndex' );
				var this_name     = $( this ).attr( 'name' );
				var this_nameBody = this_name.match( /^([\w]+)/ )[0];
				if( this_nameBody == fNameBody ) 
				{
					if( first_item === '-1' ) { 
						first_item = this_fIdx; 
					}
					if( this_fIdx > fIndex && toFocus_idx === '-1' ) {
						toFocus_idx = this_fIdx;
						// return false;
					}
					//$( jFormElem ).get( first_item ).focus();
					//alert( this_nameBody + this_fIdx );
				}
				else if( !this_name.match( /\[/ ) ) {
					if( top_item === '-1' ) {
						top_item = this_fIdx;
					}
					if( this_fIdx > fIndex && follow_item === '-1' ) {
						follow_item = this_fIdx;
					}
				}
			});
			if( toFocus_idx !== '-1' ) {
				$( jFormElem ).get( toFocus_idx ).focus();
			}
			else if( follow_item !== '-1' ) {
				$( jFormElem ).get( follow_item ).focus();
			}
			else if( top_item !== '-1' ) {
				$( jFormElem ).get( top_item ).focus();
			}
			else if( first_item !== '-1' ) {
				$( jFormElem ).get( first_item ).focus();
			}
			//alert( top_item + ' ' + follow_item );
			return;
			//alert( fNameBody[0] );
		}
		
		if( fIndex == jFormLeng-1 ) {
			$(jFormElem).get(0).focus();
		}
		else {
			$(jFormElem).get( fIndex+1 ).focus();
		}
		keyPropagate = false;
		return keyPropagate;
	};
	$(jFormElem).bind( 'keydown', 'ctrl+down', formDown );
    
	// +--------------------------------------------------------------+
	/**
     * Ctrl+UP: go up the table, or go to the previous element.
     */
    var formUp = function( event ) 
	{
		var keyPropagate = true;
		if( !focusElem ) return keyPropagate;
		if( !$(focusElem).attr( 'focusIndex' ) ) return keyPropagate;
		
		var fIndex = parseInt( $(focusElem).attr( 'focusIndex' ) );
		
		// テーブル・配列の処理
		var fName  = $(focusElem).attr( 'name' );
		if( fName.match( /\[/ ) ) 
		{
			var fNameBody = fName.match( /^([\w]+)/ )[0];
			var toFocus_idx   = '-1';
			var prev_item     = '-1'; // 配列外で、配列の前の項目
			var bottom_item   = '-1'; // 配列外で、最後の項目
			var last_item     = '-1';
			$( jFormElem ).each( function( idx )
			{
				var this_fIdx     = $( this ).attr( 'focusIndex' );
				var this_name     = $( this ).attr( 'name' );
				var this_nameBody = this_name.match( /^([\w]+)/ )[0];
				if( this_nameBody == fNameBody ) 
				{
					last_item = this_fIdx; 
					if( this_fIdx < fIndex ) {
						toFocus_idx = this_fIdx;
					}
					//$( jFormElem ).get( first_item ).focus();
				}
				else if( !this_name.match( /\[/ ) ) {
					bottom_item = this_fIdx;
					if( this_fIdx < fIndex  ) {
						prev_item = this_fIdx;
					}
				}
			});
			if( toFocus_idx !== '-1' ) {
				$( jFormElem ).get( toFocus_idx ).focus();
			}
			else if( prev_item !== '-1' ) {
				$( jFormElem ).get( prev_item ).focus();
			}
			else if( bottom_item !== '-1' ) {
				$( jFormElem ).get( bottom_item ).focus();
			}
			else if( last_item !== '-1' ) {
				$( jFormElem ).get( last_item ).focus();
			}
			return;
			//alert( fNameBody[0] );
		}
		
		if( fIndex == 0 ) {
			$(jFormElem).get( jFormLeng-1 ).focus();
		} 
		else {
			$(jFormElem).get( fIndex-1 ).focus();
		}
		keyPropagate = false;
		return keyPropagate;
	};
	$(jFormElem).bind( 'keydown', 'ctrl+up', formUp );
});
-->
</script>
<h1>Up/Down form with ctrl+↑↓→← keys</h1>
<p>Please use ctrl+up/down/left/right keys to navigate through html form in a row-table...<br>
</p>
<form name="form2" method="post" action="" id="form1">
<table border="1" bordercolor="#999999" cellpadding="2" cellspacing="0" width="600">
  <tbody>
    <tr class="tdTitleMed" align="center">
      <td bgcolor="#f0f0f0" width="78"><strong>項目名</strong></td>
      <td bgcolor="#f0f0f0" width="508"><strong>設定値</strong></td>
    </tr>
    <tr>
      <td nowrap class="tdTitle">テーブル名称</td>
      <td class="tdValue"><label>
        <input name="table_name" type="text" id="table_name" value="table name here..." size="40">
      </label></td>
    </tr>
    <tr>
      <td nowrap class="tdTitle">テーブル</td>
      <td class="tdValue"><table width="100%" border="1" cellpadding="2" cellspacing="0" bordercolor="#999999">
        <tr>
          <th bgcolor="#F0F0F0">#</th>
          <th bgcolor="#F0F0F0"><span class="tdTitle">氏名</span></th>
          <th bgcolor="#F0F0F0"><span class="tdTitle">性別</span></th>
          <th bgcolor="#F0F0F0"><span class="tdTitle">海外<br>
            flag </span></th>
          <th bgcolor="#F0F0F0"><span class="tdTitle">隠し<br>
            タグ</span></th>
          <th bgcolor="#F0F0F0"><span class="tdTitle">パスワード</span></th>
        </tr>
        <tr>
          <td>1</td>
          <td><input name="name[0]" id="name[0]" style="ime-mode: active;" size="20" type="text">
          </td>
          <td align="center"><label>
            <select name="gender[0]" id="gender[0]">
              <option value="m">Mail</option>
              <option value="f">Femail</option>
            </select>
            </label>
                <label for="radio"></label>
                <label for="label"></label>
          </td>
          <td align="center"><input name="addr_oversea_flag[0][]" id="addr_oversea_flag[0]1" value="2" type="checkbox">
          </td>
          <td><input name="hidden_tag[0]" type="hidden" value="hidden value">
          </td>
          <td><textarea name="password[0]" cols="10" rows="1" id="password[0]" style="ime-mode: inactive;">password</textarea>
          </td>
        </tr>
        <tr>
          <td>2</td>
          <td><input name="name[1]" id="name[1]" style="ime-mode: active;" size="20" type="text">
          </td>
          <td align="center"><select name="gender[1]" id="gender[1]">
            <option value="m">Mail</option>
            <option value="f">Femail</option>
          </select>
                <label for="radio"></label>
                <label for="label"></label>
          </td>
          <td align="center"><input name="addr_oversea_flag[1][]" id="addr_oversea_flag[1]1" value="2" type="checkbox">
          </td>
          <td><input name="hidden_tag[1]" type="hidden" value="hidden value">
          </td>
          <td><textarea name="password[1]" cols="10" rows="1" id="password[1]" style="ime-mode: inactive;">password</textarea>
          </td>
        </tr>
        <tr>
          <td>3</td>
          <td><input name="name[2]" id="name[2]" style="ime-mode: active;" size="20" type="text">
          </td>
          <td align="center"><select name="gender[2]" id="gender[2]">
            <option value="m">Mail</option>
            <option value="f">Femail</option>
          </select>
                <label for="radio"></label>
                <label for="label"></label>
          </td>
          <td align="center"><input name="addr_oversea_flag[2][]" id="addr_oversea_flag[2]1" value="2" type="checkbox">
          </td>
          <td><input name="hidden_tag[2]" type="hidden" value="hidden value">
          </td>
          <td><textarea name="password[2]" cols="10" rows="1" id="password[2]" style="ime-mode: inactive;">password</textarea>
          </td>
        </tr>
      </table></td>
    </tr>
    <tr>
      <td nowrap class="tdTitle">コメント</td>
      <td class="tdValue"><textarea name="comment" id="comment" cols="30" rows="4" style="ime-mode: inactive;">テキストエリア</textarea>
      </td>
    </tr>
    <tr>
      <td colspan="2" class="tdTitle" align="center"><input id="submit_button" focusindex="13" name="Submit" value="確認（サブミット）ボタン" type="submit">
          <input id="reset_button" focusindex="14" name="Reset" value="リセット" type="reset"></td>
    </tr>
  </tbody>
</table>
</form>
<br>
<br>
</body>
</html>
